{% extends 'base.html.twig' %}

{% block title %}Commande{% endblock %}

{% block body %}
    <h1>Commande</h1>
    {% for message in app.flashes('error') %}
        <div class="alert alert-danger" role="alert">{{ message }}</div>
    {% endfor %}

    <table class="table">
        <tbody>
            <tr>
                <th>Id</th>
                <td>{{ order.id }}</td>
            </tr>
            <tr>
                <th>Référence</th>
                <td>{{ order.reference }}</td>
            </tr>
            <tr>
                <th>Facture</th>
                <td>
                    {% if order.billreference %}
                        {{ order.billreference }}
                        <a href="{{ path('admin_order_download_invoice', {id: order.id}) }}" class="btn btn-sm btn-success">
                            Télécharger
                        </a>
                    {% else %}
                        <a href="{{ path('admin_order_generate_invoice', {id: order.id}) }}" class="btn btn-sm btn-primary">
                            Générer la Facture
                        </a>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <th>Status de Commande</th>
                <td>
                    {% if order.cancelled %}
                        <span class="badge bg-danger">Annuler</span>
                    {% else %}
                        <span class="badge bg-success">En attente</span>
                    {% endif %}
                </td>
            </tr>
            {% if order.cancelled %}
                <tr>
                    <th>Motif d'annulation</th>
                    <td>
                        <p>{{ order.cancelReason }}</p>
                    </td>
                </tr>
            {% endif %}
            <tr>
                <th>Status de paiement</th>
                <td>
                    {% if order.paid %}
                        <span class="badge bg-success">Payé</span>
                    {% else %}
                        <span class="badge bg-warning">Non payé</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <th>Mode de paiement</th>
                <td>
                    {% if order.paymentMethod %}
                        <span class="badge bg-primary">{{ order.paymentMethod }}</span>
                    {% else %}
                        <span class="badge bg-warning">Non défini</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <th>Date de livraison</th>
                <td>
                    {% if order.deliveryDate %}
                        {{ order.deliveryDate|date('d/m/Y') }}
                    {% else %}
                        Non définie.
                    {% endif %}
                </td>
            </tr>
            <tr>
                <th>Status de livraison</th>
                <td>
                    {% if order.deliveryDate and order.deliveryDate < date() %}
                        <span class="badge bg-success">Livré</span>
                    {% else %}
                        <span class="badge bg-warning">En attente</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <th>Livreur</th>
                <td>
                    {% if order.carrier %}
                        {{ order.carrier.name }}
                    {% else %}
                        Aucun livreur affecté.
                    {% endif %}
                </td>
            </tr>

        </tbody>
    </table>

    <h2>Produits de la commande</h2>
    <table class="table">
        <thead>
            <tr>
                <th>Nom du produit</th>
                <th>Quantité</th>
                <th>Prix unitaire</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            {% for product in order.orderProduct %}
                <tr>
                    <td>{{ product.product.title }}</td>
                    <td>{{ product.quantity }}</td>
                    <td>{{ product.product.prixVenteTtc|number_format(2, '.', ',') }} €</td>
                    <td></td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="4">Aucun produit trouvé.</td>
                </tr>
            {% endfor %}
            <tr>
                <td colspan="3"></td>
                <td>{{ order.total|number_format(2, '.', ',') }} €</td>
            </tr>
        </tbody>
    </table>
    
    <a href="{{ path('app_order_index') }}">Retour à la liste</a><br><br/>
    {% if not order.cancelled %}
    {{ include('order/paiement.html.twig') }}<br/><br/>
    
        {% if not order.paid %}
            <a href="{{ path('admin_order_toggle_payment', {id: order.id}) }}" class="btn btn-primary">Marquer comme payé</a>
        {% else %}
            <a href="{{ path('admin_order_toggle_payment', {id: order.id}) }}" class="btn btn-secondary">Marquer comme non payé</a>
        {% endif %}
    <br/><br/>
    {{ include('order/carrier.html.twig') }}<br/><br/>
    {% endif %}
    {% if not order.cancelled and order.state != 'delivered' and order.paid == false %}
        <button id="cancel-order-button" class="btn btn-danger">Annuler la commande</button>
    {% endif %}<br/><br/>


    <!-- Modal pour saisir la raison de l'annulation -->
    <div id="cancelModal" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Raison de l'annulation</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <textarea id="cancel-reason" class="form-control" placeholder="Indiquez la raison de l'annulation..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                    <button type="button" id="submit-cancel" class="btn btn-danger">Confirmer l'annulation</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Ouvrir le modal lorsque le bouton d'annulation est cliqué
            const cancelButton = document.getElementById('cancel-order-button');
            const cancelModal = document.getElementById('cancelModal');
            const submitCancelButton = document.getElementById('submit-cancel');
            const cancelReason = document.getElementById('cancel-reason');
            const orderId = "{{ order.id }}";

            cancelButton.addEventListener('click', function () {
                $('#cancelModal').modal('show');
            });

            // Soumettre la raison d'annulation et envoyer une requête AJAX
            submitCancelButton.addEventListener('click', function () {
                const reason = cancelReason.value.trim();

                if (!reason) {
                    alert('Veuillez entrer une raison pour annuler la commande.');
                    return;
                }

                // Envoi AJAX pour annuler la commande
                fetch(`/order/cancel/${orderId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: JSON.stringify({ cancelled: true, reason: reason })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Commande annulée avec succès');
                        location.reload(); // Recharger la page pour afficher l'annulation
                    } else {
                        alert('Erreur lors de l\'annulation de la commande : ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur lors de l\'annulation de la commande.');
                });

                $('#cancelModal').modal('hide');
            });
        });
    </script>
{% endblock %}
